/* 5) Data Segmentation
Segment products into cost ranges and count how many products fall into each segment
*/


WITH segments AS (

SELECT 
	product_key,
	product_name,
	cost,
CASE WHEN cost < 100 THEN 'Below 100'
	WHEN cost BETWEEN 100 AND 500 THEN '100-500'
	WHEN cost BETWEEN 500 AND 1000 THEN '500-1000'
	ELSE  'Above 1000'
END cost_range
FROM gold.dim_products
)

SELECT
	cost_range,
	COUNT(product_key) AS total_products
FROM segments
GROUP BY cost_range
ORDER BY total_products DESC

--- GROUP customers into 3 segments based on their spending behaviour
--- VIP: at least 12 months of history and spending more than £5000
--- regular: at least 12 months but spending £5000 or less
--- new: lifespan of less than 12 months
--- and find the total number of customers by each group

WITH customer_groups AS (

SELECT
	c.customer_key,
	SUM(s.sales_amount) AS total_spent,
	MIN(s.order_date) AS first_order,
	MAX(s.order_date) AS latest_order,
	DATEDIFF(month, MIN(s.order_date), MAX(s.order_date)) AS customer_lifespan
FROM gold.fact_sales s
JOIN gold.dim_customers c
ON c.customer_key = s.customer_key
GROUP BY 
	c.customer_key
) 

SELECT 
	customer_status, 
	COUNT(customer_key) AS total_customers
FROM
(

SELECT
	customer_key,
CASE 
	WHEN customer_lifespan >= 12 AND total_spent > 5000 THEN 'VIP'
	WHEN customer_lifespan >= 12 AND total_spent <= 5000 THEN 'Regular'
	ELSE 'New'
END AS customer_status
FROM customer_groups
) t

GROUP BY customer_status
ORDER  BY total_customers DESC
